# Bootstrap: docker
# From: ubuntu:22.04
Bootstrap: localimage
From: ubuntu.sif

%environment
    export LC_ALL=C
    export PATH=/usr/games:$PATH

%post
    # Define environment variables needed for install
    CABANASRC=/usr/local/src/cabana
    KOKKOSSRC=/usr/local/src/kokkos
    PREFIX=/usr/local
    echo "================Welcome to CCAKE================"
    echo "Installing Kokkos and Cabana"
    git clone https://github.com/kokkos/kokkos.git $KOKKOSSRC
    git clone https://github.com/ECP-copa/Cabana.git $CABANASRC

    # Now we need to build and install Kokkos and Cabana
    mkdir -p $KOKKOSSRC/build
    cd $KOKKOSSRC/build
    cmake -DCMAKE_BUILD_TYPE="Release" \
          -DCMAKE_INSTALL_PREFIX=$PREFIX \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_CXX_EXTENSIONS=Off \
          -DKokkos_ENABLE_COMPILER_WARNINGS=ON \
          -DKokkos_ENABLE_CUDA=Off \
          -DKokkos_ENABLE_CUDA_LAMBDA=Off \
          -DKokkos_ENABLE_OPENMP=On \
          -DKokkos_ENABLE_SERIAL=On \
          -DKokkos_ENABLE_TESTS=Off \
          -DKokkos_ARCH_SKX=Off $KOKKOSSRC

    cmake --build . --target install -j

    mkdir -p $CABANASRC/build
    cd $CABANASRC/build
    cmake -D CMAKE_BUILD_TYPE="Release" \
          -D CMAKE_CXX_STANDARD=17 \
          -D CMAKE_PREFIX_PATH=$CABANASRC \
          -D CMAKE_INSTALL_PREFIX=$PREFIX \
          -D CMAKE_CXX_COMPILER=g++\
          -D Cabana_REQUIRE_CUDA=OFF \
          -D Cabana_ENABLE_TESTING=OFF \
          -D Cabana_ENABLE_EXAMPLES=OFF $CABANASRC

    cmake --build . --target install -j

